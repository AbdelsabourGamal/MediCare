{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>MediCare</title>
    <!-- Favicons -->
    <link
      type="image/x-icon"
      href="{% static 'MediCare/images/Normal/favicon.png' %}"
      rel="icon"
    />

    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700"
      rel="stylesheet"
    />
    <!-- CSS Files -->
    <link
      rel="stylesheet"
      href="{% static 'MediCare/css/bootstrap.min.css' %}"
    />

    <link rel="stylesheet" href="{% static 'MediCare/css/all.min.css' %}" />

    <!-- Main CSS -->
    <link
      rel="stylesheet"
      href="{% static 'MediCare/css/pharmacy/style.css' %}"
    />

    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link
        type="image/x-icon"
        href="{% static 'MediCare/images/Normal/favicon.png' %}"
        rel="icon"
      />

      <!-- CSS Files -->
      <link
        rel="stylesheet"
        href="{% static 'MediCare/css/bootstrap.min.css' %}"
      />

      <link rel="stylesheet" href="{% static 'MediCare/css/all.min.css' %}" />
      <title>MediCare Payment</title>
      <style>
        :root {
          --primary: #4361ee;
          --primary-light: #4895ef;
          --success: #4bb543;
          --dark: #2b2d42;
          --light: #f8f9fa;
          --gray: #6c757d;
          --border-radius: 12px;
          --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
          --transition: all 0.3s ease;
        }

        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
          font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
          background-color: #f5f7ff;
          color: var(--dark);
          line-height: 1.6;
        }

        .payment-wrapper {
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 100vh;
          padding: 2rem;
        }

        .payment-card {
          background: white;
          border-radius: var(--border-radius);
          box-shadow: var(--box-shadow);
          width: 100%;
          max-width: 500px;
          padding: 2.5rem;
          position: relative;
          overflow: hidden;
        }

        .payment-title {
          color: var(--primary);
          font-size: 1.8rem;
          font-weight: 700;
          margin-bottom: 1.5rem;
          text-align: center;
        }

        .payment-details {
          background: var(--light);
          border-radius: var(--border-radius);
          padding: 1.5rem;
          margin-bottom: 2rem;
        }

        .detail-item {
          display: flex;
          justify-content: space-between;
          padding: 0.75rem 0;
          border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .detail-item:last-child {
          border-bottom: none;
        }

        .detail-item.total {
          font-weight: 600;
          margin-top: 0.5rem;
        }

        .highlight {
          color: var(--primary);
          font-weight: 500;
        }

        .price {
          color: var(--primary);
          font-size: 1.1rem;
          font-weight: 700;
        }

        .paypal-btn-container {
          margin: 1.5rem 0;
        }

        .payment-loading {
          display: none;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          text-align: center;
          padding: 2rem;
        }

        .loading-spinner {
          width: 50px;
          height: 50px;
          border: 4px solid rgba(67, 97, 238, 0.2);
          border-radius: 50%;
          border-top-color: var(--primary);
          animation: spin 1s ease-in-out infinite;
          margin-bottom: 1rem;
        }

        @keyframes spin {
          to {
            transform: rotate(360deg);
          }
        }

        .payment-success {
          display: none;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          text-align: center;
          padding: 2rem 0;
        }

        .success-icon {
          margin-bottom: 1.5rem;
        }

        .payment-success h3 {
          color: var(--success);
          font-size: 1.5rem;
          margin-bottom: 0.75rem;
        }

        .payment-success p {
          color: var(--gray);
          margin-bottom: 1.5rem;
          max-width: 80%;
        }

        .dashboard-btn {
          display: inline-flex;
          align-items: center;
          gap: 0.5rem;
          background: var(--primary);
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: 50px;
          text-decoration: none;
          font-weight: 500;
          transition: var(--transition);
        }

        .dashboard-btn:hover {
          background: var(--primary-light);
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        /* Responsive adjustments */
        @media (max-width: 576px) {
          .payment-card {
            padding: 1.5rem;
          }

          .payment-title {
            font-size: 1.5rem;
          }
        }
      </style>
    </head>
  </head>

  <body>
    <div class="main-wrapper">
      <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
          <!-- Logo -->
          <a class="navbar-brand" href="#">
            <img
              src="{% static 'MediCare/images/Normal/logo.png' %}"
              alt="MediCare Pharmacy Logo"
            />
          </a>

          <!-- Mobile Toggle Button -->
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarContent"
            aria-controls="navbarContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <i class="fas fa-bars"></i>
          </button>

          <!-- Navigation Content -->
          <div class="collapse navbar-collapse" id="navbarContent">
            <!-- Main Navigation Links -->
            <ul class="navbar-nav ms-auto mb-lg-0">
              <li class="nav-item">
                <a href="{% url 'patient-dashboard'%}" class="nav-link">
                  <span>Dashboard</span>
                </a>
              </li>

              <li class="nav-item">
                <a href="{% url 'pharmacy_shop'%}" class="nav-link">
                  <span>Shop</span>
                </a>
              </li>
              <li class="nav-item cart d-none d-lg-block">
                <a href="{% url 'cart' %}" class="nav-link">
                  <div class="cart-icon-wrapper">
                    <i class="fas fa-cart-shopping"></i>
                    <span class="badge badge-cart"
                      >{{order.count_cart_items}}</span
                    >
                  </div>
                </a>
              </li>
            </ul>

            <!-- Desktop Search -->
            <div class="search-box ms-lg-4 d-none d-lg-block">
              <form action="{% url 'pharmacy_shop' %}" method="GET">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search medicine..."
                  name="search_query"
                  value="{{search_query}}"
                />
              </form>
            </div>

            <!-- Mobile Search and Cart -->
            <div class="mobile-bottom-wrapper d-flex d-lg-none">
              <div class="search-box">
                <form action="{% url 'pharmacy_shop' %}" method="GET">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Search medicine..."
                    name="search_query"
                    value="{{search_query}}"
                  />
                </form>
              </div>
              <div class="nav-item cart">
                <a href="{% url 'cart' %}" class="nav-link">
                  <div class="cart-icon-wrapper">
                    <i class="fas fa-cart-shopping"></i>
                    <span class="badge badge-cart"
                      >{{order.count_cart_items}}</span
                    >
                  </div>
                </a>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <div class="payment-wrapper">
        <div class="payment-card">
          <h1 class="payment-title">Pharmacy Payment</h1>

          <div class="payment-details">
            <div class="detail-item">
              <span>Service :</span>
              <span class="highlight">Pharmacy</span>
            </div>
            <div class="detail-item">
              <span>Subtotal :</span>
              <span class="highlight">EGP {{ order.get_totals }}</span>
            </div>

            <div class="detail-item">
              <span>Delivery :</span>
              <span class="highlight">EGP 40.00</span>
            </div>

            <div class="detail-item total">
              <span>Total Amount :</span>
              <span class="price">EGP {{ order.final_bill }}</span>
            </div>
          </div>

          <div id="paypal-button-container" class="paypal-btn-container"></div>

          <div id="loading" class="payment-loading">
            <div class="loading-spinner"></div>
            <p>Securely processing your payment...</p>
          </div>

          <div id="payment-success" class="payment-success">
            <div class="success-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#4BB543"
                stroke-width="3"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
            </div>
            <h3>Payment Successful!</h3>
            <p>
              Your payment at the hospital pharmacy has been confirmed. Your
              order will be delivered to your home shortly
            </p>
            <a href="{% url 'pharmacy_shop' %}" class="dashboard-btn">
              Go To Shop
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M5 12h14M12 5l7 7-7 7"></path>
              </svg>
            </a>
          </div>
        </div>
      </div>

      <!-- Include PayPal SDK -->
      <script src="https://www.paypal.com/sdk/js?client-id=AZcgBVPHj51xJWkp82N6O-dDBBHUd5yL1G4OitnM661Q9hEQmMWC_q4qZyM-QNhcwv_mlzQRCg-aKvPh&currency=USD"></script>

      <script>
        var total = {{order.final_bill}}
        document.addEventListener('DOMContentLoaded', function() {
            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'rect',
                    label: 'paypal',
                    height: 40
                },

                // Create order
                createOrder: function(data, actions) {
                    document.getElementById('loading').style.display = 'block';
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: total,
                                currency_code: 'USD'
                            },
                            description: 'Premium Service Purchase'
                        }],
                        application_context: {
                            shipping_preference: 'NO_SHIPPING'
                        }
                    });
                },

                // On payment approval
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(details) {
                        document.getElementById('paypal-button-container').style.display = 'none';
                        document.getElementById('loading').style.display = 'none';

                        document.getElementById('payment-success').style.display = 'block';

                        fetch('/pharmacy/checkout_complete/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}',
                            },
                            body: JSON.stringify({
                                orderID: data.orderID,
                                payerID: data.payerID,
                                paymentID: details.id,
                                patient_id: '{{ patient.patient_id }}',
                                order_id: '{{ order.id }}',
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                console.log('Payment saved in database!');
                            } else {
                                console.error('Error saving payment:', data.message);
                            }
                        });
                    });
                },

                // On error
                onError: function(err) {
                    document.getElementById('loading').style.display = 'none';
                    console.error('Payment error:', err);
                    alert('Sorry, there was an error processing your payment. Please try again.');
                }
            }).render('#paypal-button-container');
        });
      </script>
      {% include 'footer.html' %}
    </div>

    <!-- Scripts -->
    <script src="{% static 'MediCare/js/jquery.min.js' %}"></script>
    <script src="{% static 'MediCare/js/popper.min.js' %}"></script>
    <script src="{% static 'MediCare/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'MediCare/js/all.min.js' %}"></script>
    <script src="{% static 'MediCare/js/script.js' %}"></script>
  </body>
</html>
